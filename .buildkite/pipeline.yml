steps:
  - label: ':docker: Build CI image'
    timeout_in_minutes: 30
    plugins:
      - docker-compose#v3.1.0:
          build: ruby-maze-runner
          image-repository: 855461928731.dkr.ecr.us-west-1.amazonaws.com/ruby
          cache-from: ruby-maze-runner:855461928731.dkr.ecr.us-west-1.amazonaws.com/ruby:base-ruby${BRANCH_NAME}
      - docker-compose#v3.1.0:
          push:
            - ruby-maze-runner:855461928731.dkr.ecr.us-west-1.amazonaws.com/ruby:base-ruby${BRANCH_NAME}
            - ruby-maze-runner:855461928731.dkr.ecr.us-west-1.amazonaws.com/ruby:base-ruby-latest

  - wait

  - label: ':rails: Rails integrations Ruby 2.7 tests'
    timeout_in_minutes: 30
    plugins:
      docker-compose#v3.1.0:
        run: ruby-maze-runner
        use-aliases: true
        command: ["features/rails_features/integrations.feature", "--tags", "@rails_integrations"]
    env:
      DEBUG: "1"
      RUBY_TEST_VERSION: "2.7"
      RAILS_VERSION: "_integrations"
